<?php
	session_start();
	require_once"recaptchalib.php";
	function randomPassword() {
	    $alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
	    $pass = array(); //remember to declare $pass as an array
	    $alphaLength = strlen($alphabet) - 1; //put the length -1 in cache
	    for ($i = 0; $i < 8; $i++) {
	        $n = rand(0, $alphaLength);
	        $pass[] = $alphabet[$n];
	    }
	    return implode($pass); //turn the array into a string
	}
	$secret="6Lcx6hgTAAAAAM0rehq87F1g0WIQYn1xmONT8qYi";
	$response=null;
	$reCaptcha= new reCaptcha($secret);
	if(isset($_POST['g-recaptcha-response'])){
		$response=$reCaptcha->verifyresponse(
			$_SERVER["REMOTE_ADDR"],	
			$_POST["g-recaptcha-response"]);
	}
	if($response==null){
		header('location:notobot.php');
	}
	if($response!=null && $response->success){
		include "db.php";
		if(isset($_SESSION["selectedevent"])){
			$arr=$_SESSION["selectedevent"];
			$enroll=$_SESSION["enrollnum"];
			$conn=mysqli_connect("localhost",$usrname,$pwd,"registration");
			$query="select * from techfestdata where enroll='$enroll'";
			if($result=mysqli_query($conn,$query)){
				$row=mysqli_fetch_assoc($result);
				$name=$row['firstname'];
				$enroll=$row['enroll'];
				$phone=$row['phone'];
				$email=$row['email'];
				$college=$row['college'];
				$sem=$row['sem'];	
				$conn=mysqli_connect("localhost",$usrname,$pwd,"registration");
				$query="delete from techfestdata where enroll='$enroll'";
				if(!mysqli_query($conn,$query)){
					echo "report error!!";
				}
				for ($i=0; $i < count($arr); $i++) { 
					$event=str_replace("_", " ",$arr[$i]);
					$query="INSERT into techfestdata(firstname,email,phone,enroll,college,sem,events) values('$name','$email','$phone','$enroll','$college','$sem','$event')";
					if($result=mysqli_query($conn,$query)){
						$_SESSION['success_id']="succcessfully registered";
					}
					else echo "q ".$query."<br>";
				}
				mysqli_close($conn);
				header("Location:congo.php");
			}
		}
	}
	else{ 
		echo "<h1>please report error to administration</h1><br>";
	}
?>
